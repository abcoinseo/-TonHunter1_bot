<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneBux - Earn & Win</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ922TyZStv/Jj2c135pM2t1FfJ9Gf6b2x19wK9F9W0fG3G6zX5X9v9V/v9Jg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Global Styles --- */
        :root {
            --primary-gradient: linear-gradient(45deg, #4ecdc4, #44a08d);
            --secondary-gradient: linear-gradient(45deg, #667eea, #764ba2);
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-color-secondary: #cccccc;
            --accent-color: #4ecdc4;
            --warning-color: #ffa726;
            --danger-color: #ff6b6b;
            --dark-bg: #1a1a1a;
            --darker-bg: #121212;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark-bg);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 90px; /* For bottom nav */
        }

        /* --- Header & Balance Bar --- */
        .top-bar {
            position: sticky;
            top: 0;
            z-index: 100;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border-color);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .balance-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .balance-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        .balance-item:hover {
            transform: translateY(-2px);
        }

        .balance-item i {
            font-size: 1.1rem;
            padding: 4px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
        }

        .balance-item .fa-ticket-alt { color: var(--danger-color); }
        .balance-item .fa-coins { color: var(--warning-color); }
        .balance-item .fa-dollar-sign { color: #34cb71; } /* For TON/USDT */
        .balance-item .fa-wallet { color: var(--accent-color); } /* For TON/USDT */

        .menu-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.3s ease;
        }
        .menu-btn:hover {
            transform: rotate(90deg);
        }

        /* --- Main Content & Container --- */
        .container {
            padding: 20px;
            max-width: 550px;
            margin: 0 auto;
        }

        .section-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            justify-content: center;
            position: relative;
        }

        .section-title i {
            color: var(--accent-color);
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        /* --- Giveaways --- */
        .giveaway-card {
            position: relative;
            overflow: hidden;
        }

        .giveaway-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .giveaway-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .giveaway-info h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .prize-info {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 10px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            background: var(--primary-gradient);
            height: 100%;
            border-radius: 10px;
            transition: width 0.7s ease-out;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            margin-top: 8px;
        }

        .participate-btn {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .participate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .participate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .my-tickets {
            text-align: center;
            margin-top: 12px;
            padding: 10px;
            background: var(--card-bg);
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
        }

        /* --- Tasks --- */
        .task-card {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .task-info {
            flex-grow: 1;
            min-width: 150px; /* Ensure it has some width */
        }

        .task-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .task-description {
            color: var(--text-color-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .task-reward {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .task-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .task-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .task-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scroll-behavior: smooth;
        }

        .category-btn {
            background: var(--card-bg);
            border: none;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .category-btn:hover, .category-btn.active {
            background: var(--primary-gradient);
            box-shadow: 0 4px 10px rgba(78, 205, 196, 0.3);
        }

        .ad-container {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px dashed var(--accent-color);
        }

        .ad-reward {
            background: var(--warning-color);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 2px 10px rgba(255, 167, 38, 0.4);
        }

        #ads-watched {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
        }

        /* --- Friends --- */
        .friends-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .friends-count {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 5px;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }

        .refer-card {
            text-align: center;
        }

        .refer-reward {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            background: var(--card-bg);
        }

        .refer-percentage {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--accent-color);
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(78, 205, 196, 0.5);
        }

        .invite-btn {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .invite-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .claim-section {
            margin-top: 25px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
        }

        .claim-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1rem;
            font-weight: 500;
        }

        .claim-amount span:first-child {
            color: var(--text-color-secondary);
        }
        .claim-amount span:last-child {
            color: var(--accent-color);
            font-weight: 700;
        }

        .claim-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        .claim-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .claim-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* --- History & Winners --- */
        .history-card {
            margin-top: 20px;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5px; /* Slightly less padding for better density */
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-user {
            font-weight: 600;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .history-user i { margin-right: 5px; }

        .history-prize {
            color: var(--warning-color);
            font-weight: 700;
        }

        /* --- Modals --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--accent-color);
            font-weight: 700;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.4);
        }

        .modal-message {
            margin-bottom: 25px;
            line-height: 1.6;
            color: var(--text-color-secondary);
            font-size: 1.1rem;
        }

        .modal-form .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .modal-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #bbb;
        }

        .modal-form input, .modal-form select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .modal-form input:focus, .modal-form select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .modal-btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            min-width: 100px; /* Consistent button width */
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-btn.danger {
            background: var(--danger-gradient);
            color: white;
        }

        .countdown {
            font-size: 1.3rem;
            color: var(--warning-color);
            font-weight: bold;
            margin: 15px 0;
            display: inline-block; /* For centering */
        }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            z-index: 99;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-color-secondary);
            text-decoration: none;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .nav-item.active {
            color: var(--accent-color);
            background: rgba(78, 205, 196, 0.1);
            font-weight: 700;
        }

        .nav-icon {
            font-size: 1.6rem;
        }

        /* --- Pages --- */
        .page {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Alerts/Notifications --- */
        .toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.4s ease, transform 0.4s ease, visibility 0.4s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            font-weight: 500;
            white-space: nowrap;
        }

        .toast-notification.active {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(10px);
        }

        .toast-notification.error {
            background: var(--danger-color);
        }

        /* --- Responsive --- */
        @media (max-width: 480px) {
            .top-bar {
                padding: 8px 10px;
            }
            .balance-wrapper {
                gap: 10px;
                justify-content: center;
                width: 100%;
                order: 2; /* Move balances below menu button on small screens */
                margin-top: 10px;
            }
            .balance-item {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            .balance-item i { font-size: 1rem; padding: 3px; }
            .menu-btn { font-size: 24px; }

            .container {
                padding: 15px;
            }
            .section-title {
                font-size: 1.4rem;
                margin-bottom: 15px;
            }
            .card { padding: 15px; margin-bottom: 15px; }

            .participate-btn, .invite-btn, .claim-btn, .modal-btn {
                font-size: 1rem;
                padding: 10px 18px;
            }
            .bottom-nav { padding: 10px 0; }
            .nav-icon { font-size: 1.4rem; }
            .nav-item { font-size: 0.7rem; }
            .modal-content { padding: 20px; }
            .modal-title { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <!-- Top Bar with Balances and Menu -->
    <div class="top-bar">
        <div class="balance-wrapper">
            <div class="balance-item">
                <i class="fas fa-ticket-alt"></i>
                <span id="ticket-balance">0.00</span>
            </div>
            <div class="balance-item">
                <i class="fas fa-coins"></i>
                <span id="gold-balance">0.00</span>
            </div>
            <div class="balance-item">
                <i class="fab fa-bitcoin"></i> <!-- Representing TON/USDT -->
                <span id="ton-usdt-balance">0.00</span>
            </div>
        </div>
        <button class="menu-btn" onclick="toggleMenu()">☰</button>
    </div>

    <!-- Menu Overlay/Sidebar (Hidden by default) -->
    <div id="menu-overlay" class="menu-overlay" style="display: none;">
        <div class="menu-content">
            <div class="menu-header">
                <img id="user-avatar" src="" alt="User Avatar" class="user-avatar">
                <div class="user-info">
                    <span id="user-name">User</span>
                    <span id="user-id">ID: N/A</span>
                </div>
                <button class="close-menu-btn" onclick="toggleMenu()">&times;</button>
            </div>
            <nav class="menu-nav">
                <a href="#" onclick="showPage('giveaways'); toggleMenu();">
                    <i class="fas fa-gift"></i> Giveaways
                </a>
                <a href="#" onclick="showPage('tasks'); toggleMenu();">
                    <i class="fas fa-tasks"></i> Tasks
                </a>
                <a href="#" onclick="showPage('friends'); toggleMenu();">
                    <i class="fas fa-users"></i> Friends
                </a>
                <a href="#" onclick="openWithdrawalModal(); toggleMenu();">
                    <i class="fas fa-wallet"></i> Withdraw
                </a>
                <a href="#" onclick="showProfile(); toggleMenu();"> <!-- Placeholder for Profile -->
                    <i class="fas fa-user-cog"></i> Profile
                </a>
            </nav>
            <div class="menu-footer">
                MoneBux v1.0
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="container">
        <!-- Giveaways Page -->
        <div id="giveaways-page" class="page active">
            <div class="section-title">
                <i class="fas fa-gift"></i> Active Giveaways
            </div>
            <div id="giveaways-container">
                <!-- Giveaways will be loaded here -->
            </div>
            <!-- Recent Winners Section -->
            <div class="card history-card">
                <div class="section-title" style="font-size: 1.3rem; margin-bottom: 15px;">
                    <i class="fas fa-trophy"></i> Recent Winners
                </div>
                <div id="recent-winners-list">
                    <!-- Recent winners will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasks-page" class="page">
            <div class="section-title">
                <i class="fas fa-star"></i> Tasks
            </div>

            <!-- Category Filter -->
            <div class="category-filter" id="category-filter">
                <button class="category-btn active" onclick="filterTasks('all')">All</button>
            </div>

            <!-- Daily Ad Task -->
            <div class="card">
                <div class="ad-container">
                    <div class="ad-reward">📺 Watch Ads - Earn 0.1 Tickets per ad</div>
                    <button class="task-btn" onclick="watchAd()">Watch Ad</button>
                    <div id="ads-watched">Today: 0/10 ads watched</div>
                    <!-- Placeholder for Ad SDK - Replace with your actual ad code -->
                    <script src='//libtl.com/sdk.js' data-zone='9900905' data-sdk='show_9900905'></script>
                </div>
            </div>

            <div id="tasks-container">
                <!-- Tasks will be loaded here -->
            </div>
        </div>

        <!-- Friends Page -->
        <div id="friends-page" class="page">
            <div class="friends-header">
                <div class="section-title">
                    <i class="fas fa-users"></i> Friends
                </div>
                <div class="friends-count" id="friends-count">0</div>
                <p style="color: var(--text-color-secondary);">Earn income from your friends!</p>
            </div>

            <div class="card refer-card">
                <div class="refer-reward">
                    <div class="refer-percentage">10%</div>
                    <p>You will receive 10% in tickets from your friends' earnings!</p>
                </div>

                <button class="invite-btn" onclick="inviteFriend()">
                    <i class="fas fa-paper-plane"></i> Invite a friend
                </button>

                <div class="claim-section">
                    <div class="claim-amount">
                        <span>Claimable:</span>
                        <span id="claimable-amount">0.00 🎫 | 0.00 💰</span>
                    </div>
                    <button class="claim-btn" onclick="claimReferral()" id="claim-referral-btn">Claim</button>
                </div>
            </div>

            <div class="card history-card">
                <div class="section-title" style="font-size: 1.3rem; margin-bottom: 15px;">
                    <i class="fas fa-hand-holding-usd"></i> Referral History
                </div>
                <div id="referral-history-list">
                    <!-- Referral history will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item active" onclick="showPage('giveaways')">
            <i class="fas fa-gift nav-icon"></i>
            <span>Giveaways</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('tasks')">
            <i class="fas fa-star nav-icon"></i>
            <span>Tasks</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('friends')">
            <i class="fas fa-users nav-icon"></i>
            <span>Friends</span>
        </a>
    </div>

    <!-- Modals -->

    <!-- Task Completion Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Task in Progress!</div>
            <div class="modal-message">
                <p>Please complete the task in the opened window.</p>
                <div class="countdown" id="countdown">10</div>
                <p>Waiting for your confirmation...</p>
            </div>
            <button class="modal-btn" onclick="completeTask()">Mark as Complete</button>
            <button class="modal-btn danger" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div id="withdrawal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Withdraw Funds</div>
            <form id="withdrawal-form" class="modal-form">
                <div class="form-group">
                    <label for="withdraw-currency">Currency</label>
                    <select id="withdraw-currency" required>
                        <option value="">Select Currency</option>
                        <option value="usdt">USDT</option>
                        <option value="ton">TON</option>
                        <option value="gold">Gold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw-amount">Amount</label>
                    <input type="number" id="withdraw-amount" step="0.01" placeholder="Enter amount" required>
                </div>
                <div class="form-group">
                    <label for="withdraw-wallet">Wallet Address</label>
                    <input type="text" id="withdraw-wallet" placeholder="Enter wallet address" required>
                </div>
                <button type="submit" class="modal-btn">Request Withdrawal</button>
                <button type="button" class="modal-btn danger" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Withdrawal History Modal -->
    <div id="withdrawal-history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Withdrawal History</div>
            <div id="withdrawal-history-list" style="max-height: 300px; overflow-y: auto; text-align: left;">
                <!-- History will be loaded here -->
            </div>
            <button class="modal-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="toast-notification"></div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, update, get, orderByChild, query, limitToLast, equalTo } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDHpiJavjopegeZO-nAGVjWjM-zmjJk07w",
            authDomain: "monebux-my-clint.firebaseapp.com",
            databaseURL: "https://monebux-my-clint-default-rtdb.firebaseio.com",
            projectId: "monebux-my-clint",
            storageBucket: "monebux-my-clint.firebasestorage.app",
            messagingSenderId: "908326371450",
            appId: "1:908326371450:web:57ffb3de904d0400007bc3"
        };

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- Global Variables ---
        let currentUser = null;
        let giveaways = {};
        let tasks = {};
        let categories = {};
        let currentTaskId = null;
        let adsWatchedToday = 0;
        const MAX_ADS_PER_DAY = 10;
        const REFERRAL_COMMISSION_RATE = 0.10; // 10%
        const TASK_COMPLETION_WINDOW = 10; // seconds
        let telegramWebApp = window.Telegram?.WebApp;

        // --- Helper Functions ---

        // Telegram WebApp Initialization
        function initTelegram() {
            if (telegramWebApp) {
                telegramWebApp.ready();
                telegramWebApp.expand();
            }
        }

        // Show Toast Notification
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast-notification');
            toastEl.textContent = message;
            toastEl.className = `toast-notification ${type} active`;
            setTimeout(() => {
                toastEl.classList.remove('active');
            }, 5000);
        }

        // Toggle Menu Overlay
        function toggleMenu() {
            const overlay = document.getElementById('menu-overlay');
            overlay.style.display = overlay.style.display === 'block' ? 'none' : 'block';
            if (overlay.style.display === 'block') {
                document.body.style.overflow = 'hidden'; // Prevent scrolling behind menu
            } else {
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // Close Modal Function
        function closeModal() {
            document.getElementById('task-modal').classList.remove('active');
            document.getElementById('withdrawal-modal').classList.remove('active');
            document.getElementById('withdrawal-history-modal').classList.remove('active');
            currentTaskId = null;
            if (document.body.style.overflow === 'hidden') {
                document.body.style.overflow = '';
            }
        }

        // Update UI Element Text
        function setText(elementId, text) {
            const el = document.getElementById(elementId);
            if (el) el.textContent = text;
        }

        // Update Balance Display
        function updateBalanceDisplay(balance) {
            setText('ticket-balance', (balance?.ticket || 0).toFixed(2));
            setText('gold-balance', (balance?.gold || 0).toFixed(2));
            const tonUsdtBalance = (balance?.ton || 0) + (balance?.usdt || 0); // Or display separately if needed
            setText('ton-usdt-balance', tonUsdtBalance.toFixed(2));
        }

        // --- Firebase Data Loading ---

        // Get Current User Data
        async function getCurrentUser(userId) {
            const userRef = ref(db, `users/${userId}`);
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                return snapshot.val();
            }
            return null;
        }

        // Initialize User and Firebase
        async function initUser() {
            let userId, username, userAvatar, referrerId = null;

            if (telegramWebApp && telegramWebApp.initDataUnsafe && telegramWebApp.initDataUnsafe.user) {
                userId = telegramWebApp.initDataUnsafe.user.id.toString();
                username = telegramWebApp.initDataUnsafe.user.username || telegramWebApp.initDataUnsafe.user.first_name || 'User';
                userAvatar = telegramWebApp.initDataUnsafe.user.photo_url || ''; // Telegram avatar URL
                const urlParams = new URLSearchParams(window.location.search);
                referrerId = urlParams.get('start');
            } else {
                // Fallback for testing or non-Telegram environment
                userId = localStorage.getItem('demoUserId') || `demo_user_${Date.now()}`;
                username = localStorage.getItem('demoUserName') || 'Demo User';
                userAvatar = 'https://www.gravatar.com/avatar/placeholder?s=50&d=identicon'; // Placeholder avatar
                localStorage.setItem('demoUserId', userId);
                localStorage.setItem('demoUserName', username);
            }

            currentUser = {
                id: userId,
                username: username,
                avatar: userAvatar
            };

            // Update menu with user info
            const userMenuAvatar = document.getElementById('user-avatar');
            userMenuAvatar.src = currentUser.avatar || 'https://www.gravatar.com/avatar/placeholder?s=50&d=identicon';
            setText('user-name', currentUser.username);
            setText('user-id', `ID: ${currentUser.id.slice(-6)}`); // Display last 6 digits for brevity

            const userRef = ref(db, `users/${userId}`);
            const userSnapshot = await get(userRef);

            if (!userSnapshot.exists()) {
                // New user flow
                const newUser = {
                    id: userId,
                    username: username,
                    balance: { ticket: 0, gold: 0, ton: 0, usdt: 0 },
                    createdAt: Date.now(),
                    referredBy: referrerId,
                    referrals: {},
                    completedTasks: {},
                    giveawayParticipations: {},
                    lastAdDate: null,
                    adsWatchedToday: 0,
                    claimableReferral: { ticket: 0, gold: 0, ton: 0, usdt: 0 },
                    withdrawalHistory: {}
                };
                await set(userRef, newUser);

                // If referred, link to referrer
                if (referrerId) {
                    const referrerRef = ref(db, `users/${referrerId}/referrals/${userId}`);
                    await set(referrerRef, {
                        username: username,
                        joinedAt: Date.now(),
                        commissionRate: REFERRAL_COMMISSION_RATE // Store rate at join time
                    });
                }
            }

            // Listen for user data changes
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    currentUser = { ...currentUser, ...userData }; // Merge with existing currentUser
                    updateBalanceDisplay(userData.balance);
                    adsWatchedToday = userData.adsWatchedToday || 0;
                    updateAdsDisplay();
                    updateClaimableAmount(userData.claimableReferral);
                    updateFriendsCount(userData.referrals);
                    renderReferralHistory(userData.withdrawalHistory);
                }
            });

            loadInitialData();
        }

        // Load initial data (Giveaways, Tasks, Categories)
        function loadInitialData() {
            loadGiveaways();
            loadTasks();
            loadCategories();
            loadRecentWinners();
        }

        // Load Giveaways
        function loadGiveaways() {
            const giveawaysRef = ref(db, 'giveaways');
            onValue(giveawaysRef, (snapshot) => {
                giveaways = snapshot.val() || {};
                renderGiveaways();
                checkGiveawayCompletions();
            });
        }

        // Render Giveaways
        function renderGiveaways() {
            const container = document.getElementById('giveaways-container');
            container.innerHTML = ''; // Clear existing

            const activeGiveaways = Object.entries(giveaways).filter(([id, giveaway]) => !giveaway.completed);

            if (activeGiveaways.length === 0) {
                container.innerHTML = '<div class="card"><p>No active giveaways available. Check back soon!</p></div>';
                return;
            }

            activeGiveaways.forEach(([id, giveaway]) => {
                const participantsCount = Object.keys(giveaway.participants || {}).length;
                const progress = giveaway.totalTickets > 0 ? Math.min(100, Math.round((participantsCount / giveaway.totalTickets) * 100)) : 0;
                const userTicketsForThisGiveaway = giveaway.participants?.[currentUser.id] || 0;

                const card = document.createElement('div');
                card.className = 'card giveaway-card';
                card.innerHTML = `
                    <div class="giveaway-header">
                        <img src="${giveaway.icon}" alt="Icon" class="giveaway-icon">
                        <div class="giveaway-info">
                            <h3>${giveaway.title}</h3>
                            <div class="prize-info">
                                <i class="fas fa-wallet"></i> ${giveaway.prizeAmount} ${giveaway.prizeType.toUpperCase()}
                            </div>
                        </div>
                    </div>

                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>

                    <div class="progress-text">
                        <span>${participantsCount}/${giveaway.totalTickets} tickets sold</span>
                        <span>${progress}%</span>
                    </div>

                    <button class="participate-btn" onclick="participateGiveaway('${id}')"
                        data-ticket-price="${giveaway.ticketPrice}"
                        data-user-tickets="${userTicketsForThisGiveaway}">
                        ${userTicketsForThisGiveaway > 0 ? `My Tickets: ${userTicketsForThisGiveaway}` : `Buy Ticket (${giveaway.ticketPrice} 🎟️)`}
                    </button>

                    <div class="my-tickets">
                        Cost per ticket: ${giveaway.ticketPrice} 🎟️
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Participate in Giveaway
        window.participateGiveaway = async function(giveawayId) {
            const giveaway = giveaways[giveawayId];
            if (!giveaway || giveaway.completed) return showToast('This giveaway is no longer active.', 'error');

            const participateButton = event.target;
            const ticketPrice = parseFloat(participateButton.dataset.ticketPrice);
            const userTickets = parseFloat(participateButton.dataset.userTickets);

            if (currentUser.balance.ticket < ticketPrice) {
                return showToast('Insufficient tickets!', 'error');
            }

            try {
                // Deduct tickets
                await update(ref(db, `users/${currentUser.id}/balance`), { ticket: currentUser.balance.ticket - ticketPrice });

                // Add to giveaway participants
                const currentParticipation = giveaway.participants?.[currentUser.id] || 0;
                await update(ref(db, `giveaways/${giveawayId}/participants`), {
                    [currentUser.id]: currentParticipation + ticketPrice
                });

                showToast('Successfully purchased ticket!');
                // Update button text if needed (handled by onValue listener for balance)
            } catch (error) {
                console.error("Error participating in giveaway:", error);
                showToast('Failed to participate. Please try again.', 'error');
            }
        }

        // Check and Handle Giveaway Completions
        async function checkGiveawayCompletions() {
            const completedGiveawayIds = []; // Track giveaways already processed in this run

            for (const [id, giveaway] of Object.entries(giveaways)) {
                if (!giveaway.completed) {
                    const participantsTickets = giveaway.participants || {};
                    const totalTicketsSold = Object.values(participantsTickets).reduce((sum, tickets) => sum + tickets, 0);

                    if (totalTicketsSold >= giveaway.totalTickets) {
                        completedGiveawayIds.push(id); // Mark for processing

                        // Select a winner (weighted by tickets bought)
                        const participantsArray = [];
                        for (const [userId, tickets] of Object.entries(participantsTickets)) {
                            for (let i = 0; i < tickets / giveaway.ticketPrice; i++) { // Add one entry per ticket bought
                                participantsArray.push(userId);
                            }
                        }

                        if (participantsArray.length === 0) continue; // No participants, skip

                        const winnerId = participantsArray[Math.floor(Math.random() * participantsArray.length)];
                        const winnerUsername = currentUser.id === winnerId ? currentUser.username : (await getCurrentUser(winnerId))?.username || `User #${winnerId.slice(-4)}`;

                        // Award prize to winner
                        const prizeType = giveaway.prizeType;
                        const prizeAmount = giveaway.prizeAmount;
                        let newBalance = {};

                        if (prizeType === 'ton' || prizeType === 'usdt') {
                            const currentCryptoBalance = currentUser.balance[prizeType] || 0;
                            newBalance[prizeType] = currentCryptoBalance + prizeAmount;
                        } else { // gold or other types
                            const currentOtherBalance = currentUser.balance[prizeType] || 0;
                            newBalance[prizeType] = currentOtherBalance + prizeAmount;
                        }

                        // Update winner's balance
                        await update(ref(db, `users/${winnerId}/balance`), newBalance);

                        // Add to winners history
                        const winnersRef = ref(db, 'winners');
                        const newWinnerEntry = {
                            userId: winnerId,
                            username: winnerUsername,
                            giveawayId: id,
                            giveawayTitle: giveaway.title,
                            prizeAmount: prizeAmount,
                            prizeType: prizeType,
                            wonAt: Date.now()
                        };
                        const newWinnerRef = push(winnersRef);
                        await set(newWinnerRef, newWinnerEntry);

                        // Update giveaway as completed
                        await update(ref(db, `giveaways/${id}`), {
                            completed: true,
                            winnerId: winnerId,
                            winnerUsername: winnerUsername,
                            completedAt: Date.now()
                        });

                        showToast(`${winnerUsername} won the ${giveaway.title} giveaway!`);
                    }
                }
            }
            // After processing, remove any already completed giveaways from active rendering if necessary
            // The onValue listener will naturally update the UI when data changes
        }

        // Load Categories
        function loadCategories() {
            const categoriesRef = ref(db, 'categories');
            onValue(categoriesRef, (snapshot) => {
                categories = snapshot.val() || {};
                renderCategoryFilter();
            });
        }

        // Render Category Filter Buttons
        function renderCategoryFilter() {
            const container = document.getElementById('category-filter');
            // Ensure 'All' button is always present and first
            const allButton = container.querySelector('.category-btn[onclick*="filterTasks(\'all\')"]');
            if (!allButton) {
                const btn = document.createElement('button');
                btn.className = 'category-btn active';
                btn.textContent = 'All';
                btn.onclick = () => filterTasks('all');
                container.prepend(btn);
            } else {
                // Reset active state if 'All' was not the last selected
                if (!event.target || !event.target.classList.contains('category-btn')) {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    allButton.classList.add('active');
                }
            }

            // Add category buttons, avoiding duplicates
            Object.entries(categories).forEach(([id, category]) => {
                const exists = container.querySelector(`button[data-category-id="${id}"]`);
                if (!exists) {
                    const button = document.createElement('button');
                    button.className = 'category-btn';
                    button.dataset.categoryId = id; // Use dataset for identification
                    button.textContent = category.name;
                    button.onclick = () => filterTasks(id);
                    container.appendChild(button);
                }
            });
        }

        // Load Tasks
        function loadTasks() {
            const tasksRef = ref(db, 'tasks');
            onValue(tasksRef, (snapshot) => {
                tasks = snapshot.val() || {};
                renderTasks();
            });
        }

        // Filter Tasks by Category
        window.filterTasks = function(categoryId) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            // Find the button that corresponds to the categoryId
            const targetButton = document.querySelector(`.category-btn[data-category-id="${categoryId}"]`) || document.querySelector('.category-btn[onclick*="filterTasks(\'all\')"]');
            if (targetButton) targetButton.classList.add('active');

            renderTasks(categoryId);
        }

        // Render Tasks
        function renderTasks(filterCategory = 'all') {
            const container = document.getElementById('tasks-container');
            container.innerHTML = ''; // Clear existing

            const tasksToRender = Object.entries(tasks).filter(([id, task]) => {
                return filterCategory === 'all' || task.categoryId === filterCategory;
            });

            if (tasksToRender.length === 0 && filterCategory !== 'all') {
                container.innerHTML = '<div class="card"><p>No tasks found in this category.</p></div>';
                return;
            } else if (tasksToRender.length === 0 && filterCategory === 'all') {
                container.innerHTML = '<div class="card"><p>No tasks available yet. Check back soon!</p></div>';
                return;
            }


            tasksToRender.forEach(([id, task]) => {
                const isCompleted = task.completions?.[currentUser.id];

                const card = document.createElement('div');
                card.className = 'card task-card';
                card.innerHTML = `
                    <img src="${task.icon}" alt="Icon" class="task-icon">
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-description">${task.description}</div>
                        <div class="task-reward">
                            <i class="fas fa-gift"></i> +${task.rewardAmount} ${task.rewardType.toUpperCase()}
                        </div>
                    </div>
                    <button class="task-btn" ${isCompleted ? 'disabled' : ''} onclick="startTask('${id}', '${task.link}', '${task.rewardType}', ${task.rewardAmount})">
                        ${isCompleted ? 'Completed' : 'Start'}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // Start Task
        window.startTask = function(taskId, taskLink, rewardType, rewardAmount) {
            currentTaskId = { id: taskId, type: rewardType, amount: rewardAmount };
            window.open(taskLink, '_blank');

            // Show countdown modal
            document.getElementById('task-modal').classList.add('active');
            startCountdown();
            if (document.body.style.overflow === '') { // Only apply if not already hidden by menu
                document.body.style.overflow = 'hidden';
            }
        }

        // Start Countdown for Task Completion Window
        function startCountdown() {
            let count = TASK_COMPLETION_WINDOW;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = count;

            const timer = setInterval(() => {
                count--;
                countdownEl.textContent = count;
                if (count <= 0) {
                    clearInterval(timer);
                    countdownEl.textContent = 'Expired!';
                }
            }, 1000);
        }

        // Mark Task as Complete
        window.completeTask = async function() {
            if (!currentTaskId) return closeModal();

            const { id, type, amount } = currentTaskId;

            try {
                // Mark task as completed for the user
                await update(ref(db, `tasks/${id}/completions`), {
                    [currentUser.id]: Date.now()
                });

                // Award user
                const userBalanceRef = ref(db, `users/${currentUser.id}/balance/${type}`);
                const currentBalance = currentUser.balance[type] || 0;
                await set(userBalanceRef, currentBalance + amount);

                // Award referrer commission
                if (currentUser.referredBy) {
                    const commission = amount * REFERRAL_COMMISSION_RATE;
                    const referrerClaimableRef = ref(db, `users/${currentUser.referredBy}/claimableReferral/${type}`);
                    const referrerClaimableSnapshot = await get(referrerClaimableRef);
                    const currentClaimable = referrerClaimableSnapshot.val() || 0;
                    await set(referrerClaimableRef, currentClaimable + commission);
                }

                showToast(`Task completed! +${amount} ${type.toUpperCase()}`);
                closeModal();
                currentTaskId = null; // Reset
            } catch (error) {
                console.error("Error completing task:", error);
                showToast('Failed to mark task as complete. Please try again.', 'error');
                closeModal();
            }
        }

        // Watch Ad
        window.watchAd = function() {
            const today = new Date().toDateString();
            const lastAdDate = localStorage.getItem('lastAdDate');

            if (lastAdDate !== today) {
                adsWatchedToday = 0;
                localStorage.setItem('lastAdDate', today);
            }

            if (adsWatchedToday >= MAX_ADS_PER_DAY) {
                showToast('Maximum ads watched for today!', 'error');
                return;
            }

            // Simulate ad display and completion
            // In a real scenario, this would be an actual ad network SDK call
            showToast('Displaying ad...', 'info');
            setTimeout(async () => {
                // Award user
                const adRewardAmount = 0.1; // Tickets
                const userBalanceRef = ref(db, `users/${currentUser.id}/balance/ticket`);
                const currentBalance = currentUser.balance.ticket || 0;
                await set(userBalanceRef, currentBalance + adRewardAmount);

                // Update ads watched count
                adsWatchedToday++;
                await update(ref(db, `users/${currentUser.id}`), {
                    adsWatchedToday: adsWatchedToday,
                    lastAdDate: today
                });

                // Award referrer commission
                if (currentUser.referredBy) {
                    const commission = adRewardAmount * REFERRAL_COMMISSION_RATE;
                    const referrerClaimableRef = ref(db, `users/${currentUser.referredBy}/claimableReferral/ticket`);
                    const referrerClaimableSnapshot = await get(referrerClaimableRef);
                    const currentClaimable = referrerClaimableSnapshot.val() || 0;
                    await set(referrerClaimableRef, currentClaimable + commission);
                }

                showToast(`Ad completed! +${adRewardAmount} Tickets`);
                updateAdsDisplay();
            }, 10000); // Simulate a 10-second ad duration
        }

        // Update Ads Watched Display
        function updateAdsDisplay() {
            setText('ads-watched', `Today: ${adsWatchedToday}/${MAX_ADS_PER_DAY} ads watched`);
        }

        // Invite Friend Functionality
        window.inviteFriend = function() {
            const referLink = `https://t.me/yourbot_username/app?startapp=${currentUser.id}`; // IMPORTANT: Replace 'yourbot_username'
            const shareText = `🎁 Join MoneBux and start earning tickets and rewards! Use my referral link and get a bonus!`;

            if (telegramWebApp) {
                // Use Telegram's share functionality if available
                telegramWebApp.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(referLink)}&text=${encodeURIComponent(shareText)}`);
            } else {
                // Fallback for web browsers: copy to clipboard
                navigator.clipboard.writeText(referLink).then(() => {
                    showToast('Referral link copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy referral link: ', err);
                    showToast('Failed to copy link. Please copy manually.', 'error');
                });
            }
        }

        // Update Friends Count Display
        function updateFriendsCount(referrals) {
            const count = Object.keys(referrals || {}).length;
            setText('friends-count', count);
        }

        // Update Claimable Referral Amount Display
        function updateClaimableAmount(claimable) {
            const ticket = claimable?.ticket || 0;
            const gold = claimable?.gold || 0;
            const ton = claimable?.ton || 0;
            const usdt = claimable?.usdt || 0;
            setText('claimable-amount', `${ticket.toFixed(2)} 🎫 | ${gold.toFixed(2)} 💰 | ${ton.toFixed(2)} 💎 | ${usdt.toFixed(2)} 💲`);
            // Enable/disable claim button
            const claimBtn = document.getElementById('claim-referral-btn');
            if (ticket > 0 || gold > 0 || ton > 0 || usdt > 0) {
                claimBtn.disabled = false;
            } else {
                claimBtn.disabled = true;
            }
        }

        // Claim Referral Rewards
        window.claimReferral = async function() {
            if (!currentUser || !currentUser.claimableReferral) return showToast('User data not loaded.', 'error');

            const claimable = currentUser.claimableReferral;
            const { ticket, gold, ton, usdt } = claimable;

            if (ticket === 0 && gold === 0 && ton === 0 && usdt === 0) {
                return showToast('No rewards to claim!', 'error');
            }

            const updatedBalance = { ...currentUser.balance };
            updatedBalance.ticket = (updatedBalance.ticket || 0) + ticket;
            updatedBalance.gold = (updatedBalance.gold || 0) + gold;
            updatedBalance.ton = (updatedBalance.ton || 0) + ton;
            updatedBalance.usdt = (updatedBalance.usdt || 0) + usdt;

            try {
                await update(ref(db, `users/${currentUser.id}`), {
                    balance: updatedBalance,
                    claimableReferral: { ticket: 0, gold: 0, ton: 0, usdt: 0 } // Reset claimable
                });
                showToast('Referral rewards claimed successfully!');
            } catch (error) {
                console.error("Error claiming referral rewards:", error);
                showToast('Failed to claim rewards. Please try again.', 'error');
            }
        }

        // Load Recent Winners
        function loadRecentWinners() {
            const winnersRef = ref(db, 'winners');
            // Query for the last 10 winners, ordered by timestamp
            const recentWinnersQuery = query(winnersRef, orderByChild('wonAt'), limitToLast(10));

            onValue(recentWinnersQuery, (snapshot) => {
                const winners = snapshot.val() || {};
                renderRecentWinners(Object.values(winners).sort((a, b) => b.wonAt - a.wonAt)); // Ensure chronological order
            });
        }

        // Render Recent Winners List
        function renderRecentWinners(winners) {
            const container = document.getElementById('recent-winners-list');
            container.innerHTML = ''; // Clear existing

            if (!winners || winners.length === 0) {
                container.innerHTML = '<p class="card">🐻 No winners yet</p>';
                return;
            }

            winners.forEach(winner => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="history-user">
                        <i class="fas fa-user-circle"></i> ${winner.username || `User #${winner.userId.slice(-4)}`}
                    </div>
                    <div class="history-prize">
                        <i class="fas fa-wallet"></i> ${winner.prizeAmount.toFixed(2)} ${winner.prizeType.toUpperCase()}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // Render Referral History (Withdrawal History)
        function renderReferralHistory(history) {
            const container = document.getElementById('referral-history-list');
            container.innerHTML = ''; // Clear existing

            const sortedHistory = Object.values(history || {}).sort((a, b) => b.createdAt - a.createdAt);

            if (!sortedHistory || sortedHistory.length === 0) {
                container.innerHTML = '<p class="card">You have no withdrawal history yet.</p>';
                return;
            }

            sortedHistory.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'history-item';
                const statusIcon = entry.status === 'approved' ? '<i class="fas fa-check-circle" style="color: #34cb71;"></i>' :
                                   entry.status === 'rejected' ? '<i class="fas fa-times-circle" style="color: var(--danger-color);"></i>' :
                                   '<i class="fas fa-clock" style="color: var(--warning-color);"></i>';
                const statusText = entry.status.charAt(0).toUpperCase() + entry.status.slice(1);

                item.innerHTML = `
                    <div>
                        <div class="history-user">${statusIcon} ${statusText}</div>
                        <div style="font-size: 0.8rem; color: var(--text-color-secondary);">
                            ${new Date(entry.createdAt).toLocaleString()}
                        </div>
                    </div>
                    <div class="history-prize">
                        ${entry.amount.toFixed(2)} ${entry.type.toUpperCase()}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // --- Page Navigation ---
        window.showPage = function(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));

            document.getElementById(`${pageName}-page`).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
        }

        // --- Modals ---

        // Open Withdrawal Modal
        window.openWithdrawalModal = function() {
            document.getElementById('withdrawal-modal').classList.add('active');
            if (document.body.style.overflow === '') { // Only apply if not already hidden by menu
                document.body.style.overflow = 'hidden';
            }
            // Pre-fill form if needed, or reset it
            document.getElementById('withdrawal-form').reset();
        }

        // Handle Withdrawal Request
        document.getElementById('withdrawal-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currency = document.getElementById('withdraw-currency').value;
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const wallet = document.getElementById('withdraw-wallet').value.trim();

            if (!currency || !amount || !wallet || isNaN(amount) || amount <= 0) {
                return showToast('Please fill in all fields correctly.', 'error');
            }

            const selectedCurrencyBalance = currentUser.balance[currency] || 0;
            if (amount > selectedCurrencyBalance) {
                return showToast(`Insufficient ${currency.toUpperCase()} balance.`, 'error');
            }

            // Validate wallet address format (basic check)
            if (currency === 'ton' && !wallet.startsWith('UQ')) { // Example TON prefix
                // showToast('Invalid TON wallet address format.', 'error');
                // return; // Uncomment for strict validation
            }
            if (currency === 'usdt' && !wallet.startsWith('0x')) { // Example ETH/BSC USDT prefix
                // showToast('Invalid USDT wallet address format.', 'error');
                // return; // Uncomment for strict validation
            }

            const withdrawalEntry = {
                userId: currentUser.id,
                username: currentUser.username,
                amount: amount,
                type: currency,
                wallet: wallet,
                status: 'pending',
                createdAt: Date.now(),
                processedAt: null
            };

            try {
                // Deduct from user balance immediately
                const newBalance = { ...currentUser.balance };
                newBalance[currency] -= amount;
                await update(ref(db, `users/${currentUser.id}/balance`), newBalance);

                // Add to withdrawal history (admin will manage actual payout)
                const withdrawalHistoryRef = ref(db, `users/${currentUser.id}/withdrawalHistory/${push(ref(db)).key}`);
                await set(withdrawalHistoryRef, withdrawalEntry);

                showToast('Withdrawal request submitted successfully!', 'info');
                closeModal();
            } catch (error) {
                console.error("Error submitting withdrawal:", error);
                showToast('Failed to submit withdrawal request. Please try again.', 'error');
                // Revert balance deduction if history failed to save (important for atomicity)
                // This is complex and often requires transactions or server-side logic.
                // For simplicity here, we'll assume it's handled or accept potential inconsistencies.
            }
        });

        // Open Withdrawal History Modal
        function openWithdrawalHistoryModal() {
            document.getElementById('withdrawal-history-modal').classList.add('active');
             if (document.body.style.overflow === '') { // Only apply if not already hidden by menu
                document.body.style.overflow = 'hidden';
            }
            renderReferralHistory(currentUser.withdrawalHistory); // Re-render to ensure fresh data
        }

        // Profile function (Placeholder)
        window.showProfile = function() {
            showToast('Profile page not implemented yet.');
        }

        // --- Initialization ---
        async function initApp() {
            initTelegram();
            await initUser();
            // Initial rendering is handled by onValue listeners once user is initialized
        }

        initApp();
    </script>
</body>
</html>
