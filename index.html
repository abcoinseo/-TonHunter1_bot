<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoneBux - Earn & Win</title>
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- Telegram WebApp JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
            display: flex;
            flex-direction: column;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky; /* Make header sticky */
            top: 0;
            z-index: 100; /* Ensure it stays above other content */
        }

        .balance-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }

        .balance-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .balance-item .material-icons {
            font-size: 20px;
            color: #ffffff;
        }

        .balance-item .ticket-icon { color: #ff4757; }
        .balance-item .gold-icon { color: #ffa726; }
        .balance-item .ton-icon { color: #0077ff; } /* Example TON color */
        .balance-item .usdt-icon { color: #007bff; } /* Example USDT color */

        .menu-btn {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 5px;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1; /* Allow main content to take available space */
            padding-bottom: 80px; /* Space for bottom nav */
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .section-title .material-icons {
            font-size: 28px;
            color: #4ecdc4;
        }

        /* Card Styles */
        .card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* Giveaway Card */
        .giveaway-card {
            position: relative;
            overflow: hidden;
        }

        .giveaway-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .giveaway-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .giveaway-info h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
            color: #e0e0e0;
        }

        .prize-info {
            color: #4ecdc4;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 10px;
            margin: 15px 0;
            overflow: hidden;
            position: relative; /* For text overlay */
        }

        .progress-fill {
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
            position: absolute;
            top: 0;
            left: 0;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #cccccc;
            margin-top: 5px;
        }

        .participate-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .participate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .participate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
        }

        .my-tickets {
            text-align: center;
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.9rem;
            color: #cccccc;
        }

        /* Task Card */
        .task-card {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .task-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .task-info {
            flex-grow: 1;
        }

        .task-title {
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: #e0e0e0;
        }

        .task-description {
            color: #cccccc;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .task-reward {
            color: #4ecdc4;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .task-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .task-btn:hover {
            transform: scale(1.05);
        }

        .task-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Category Filter */
        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scroll-behavior: smooth;
        }

        .category-filter::-webkit-scrollbar {
            height: 5px;
        }

        .category-filter::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .category-filter::-webkit-scrollbar-thumb {
            background: #4ecdc4;
            border-radius: 10px;
        }

        .category-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #ffffff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .category-btn:hover, .category-btn.active {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
        }

        /* Ad Container */
        .ad-container {
            text-align: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ad-reward {
            background: linear-gradient(45deg, #f5a623, #f88a12);
            color: white;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: 600;
            font-size: 1rem;
        }

        /* Friends Section */
        .friends-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .friends-count {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 5px;
        }

        .refer-card {
            text-align: center;
        }

        .refer-reward {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .refer-percentage {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
            margin-bottom: 10px;
        }

        .invite-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .invite-btn .material-icons {
            font-size: 24px;
        }

        .invite-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .claim-section {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .claim-amount {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #cccccc;
            flex-wrap: wrap;
            gap: 10px;
        }

        .claim-amount span:first-child {
            font-weight: 500;
        }

        .claim-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .claim-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .claim-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
        }

        /* History Section */
        .history-card {
            margin-top: 30px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-user {
            font-weight: 600;
            color: #e0e0e0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .history-prize {
            color: #4ecdc4;
            font-weight: 600;
        }

        .history-status {
            font-weight: 500;
            text-transform: capitalize;
        }

        .history-status.pending { color: #ffa726; }
        .history-status.approved { color: #66bb6a; }
        .history-status.rejected { color: #ef5350; }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            color: #4ecdc4;
            font-weight: 700;
        }

        .modal-message {
            margin-bottom: 20px;
            line-height: 1.5;
            color: #e0e0e0;
            font-size: 1rem;
        }

        .modal-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin: 5px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .modal-btn:hover {
            transform: scale(1.05);
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }

        .modal-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .countdown {
            font-size: 1.2rem;
            color: #ffa726;
            font-weight: bold;
            margin: 10px 0;
        }

        /* Forms */
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #cccccc;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }

        .form-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .submit-btn {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #888;
            text-decoration: none;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 10px;
        }

        .nav-item.active {
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
        }

        .nav-icon {
            font-size: 1.8rem;
        }

        /* Page Transitions */
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in;
            flex-grow: 1; /* Make pages fill available space */
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Media Queries */
        @media (max-width: 480px) {
            .header { padding: 10px 15px; }
            .balance-container { gap: 10px; }
            .balance-item { padding: 6px 12px; font-size: 0.8rem; }
            .balance-item .material-icons { font-size: 18px; }
            .menu-btn { font-size: 20px; }
            .container { padding: 15px; }
            .section-title { font-size: 1.3rem; }
            .card { padding: 15px; }
            .participate-btn { padding: 10px 15px; font-size: 0.95rem; }
            .bottom-nav { padding: 10px 0; }
            .nav-icon { font-size: 1.5rem; }
            .nav-item { font-size: 0.7rem; }
            .friends-count { font-size: 2rem; }
        }

        @media (max-width: 320px) {
            .balance-item { display: none; } /* Hide balances on very small screens */
            .header { padding: 10px; }
            .menu-btn { margin-left: auto; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="balance-container">
            <div class="balance-item">
                <span class="material-icons ticket-icon">confirmation_number</span>
                <span id="ticket-balance">0.00</span>
            </div>
            <div class="balance-item">
                <span class="material-icons gold-icon">star</span>
                <span id="gold-balance">0.00</span>
            </div>
            <div class="balance-item">
                <span class="material-icons ton-icon">paid</span>
                <span id="ton-balance">0.00</span>
            </div>
            <div class="balance-item">
                <span class="material-icons usdt-icon">account_balance_wallet</span>
                <span id="usdt-balance">0.00</span>
            </div>
        </div>
        <button class="menu-btn" onclick="toggleMoreMenu()">
            <span class="material-icons">more_vert</span>
        </button>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Giveaways Page -->
        <div id="giveaways-page" class="page active">
            <div class="container">
                <div class="section-title">
                    <span class="material-icons">redeem</span> Giveaways
                </div>
                <div id="giveaways-container">
                    <!-- Giveaways will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Tasks Page -->
        <div id="tasks-page" class="page">
            <div class="container">
                <div class="section-title">
                    <span class="material-icons">assignment_turned_in</span> Tasks
                </div>
                
                <!-- Category Filter -->
                <div class="category-filter" id="category-filter">
                    <button class="category-btn active" onclick="filterTasks('all')">All</button>
                </div>
                
                <!-- Daily Ad Task -->
                <div class="card">
                    <div class="ad-container">
                        <div class="ad-reward">📺 Watch Ads - Earn 0.1 Tickets per ad</div>
                        <button class="task-btn" onclick="watchAd()">Watch Ad</button>
                        <div id="ads-watched">Today: 0/10 ads watched</div>
                        <!-- Replace with your actual ad SDK script if needed -->
                        <script src='//libtl.com/sdk.js' data-zone='9900905' data-sdk='show_9900905'></script>
                    </div>
                </div>
                
                <div id="tasks-container">
                    <!-- Tasks will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Friends Page -->
        <div id="friends-page" class="page">
            <div class="container">
                <div class="friends-header">
                    <div class="section-title">
                        <span class="material-icons">group</span> Friends
                    </div>
                    <div class="friends-count" id="friends-count">0</div>
                    <p>Earn income from your friends!</p>
                </div>
                
                <div class="card refer-card">
                    <div class="refer-reward">
                        <div class="refer-percentage">10%</div>
                        <p>You will receive 10% in tickets from your friends' earnings!</p>
                    </div>
                    
                    <button class="invite-btn" onclick="inviteFriend()">
                        <span class="material-icons">person_add</span> Invite a friend
                    </button>
                    
                    <div class="claim-section">
                        <div class="claim-amount">
                            <span>Claimable:</span>
                            <span id="claimable-amount">0.00 🎫 0.00 🏆</span>
                        </div>
                        <button class="claim-btn" id="claim-referral-btn" onclick="claimReferral()">Claim</button>
                    </div>
                </div>
                
                <div class="card history-card">
                    <h3>Recent Winners</h3>
                    <div id="recent-winners">
                        <!-- Winners will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- History Page -->
        <div id="history-page" class="page">
            <div class="container">
                <div class="section-title">
                    <span class="material-icons">history</span> History
                </div>
                <div class="card">
                    <h3>Withdrawal History</h3>
                    <div id="withdrawals-history-container">
                        <!-- Withdrawal history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="#" class="nav-item" onclick="showPage('giveaways')">
            <span class="material-icons nav-icon">redeem</span>
            <span>Giveaways</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('tasks')">
            <span class="material-icons nav-icon">assignment_turned_in</span>
            <span>Tasks</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('friends')">
            <span class="material-icons nav-icon">group</span>
            <span>Friends</span>
        </a>
        <a href="#" class="nav-item" onclick="showPage('history')">
            <span class="material-icons nav-icon">history</span>
            <span>History</span>
        </a>
    </div>

    <!-- Modals -->

    <!-- More Menu (Withdrawals, etc.) -->
    <div id="more-menu-modal" class="modal">
        <div class="modal-content" style="max-width: 280px;">
            <div class="modal-title">More Options</div>
            <button class="modal-btn secondary" onclick="openWithdrawalModal()">
                <span class="material-icons" style="font-size: 20px; margin-right: 5px;">payment</span> Withdraw
            </button>
            <button class="modal-btn secondary" onclick="closeModal('more-menu-modal')">
                Cancel
            </button>
        </div>
    </div>

    <!-- Task Completion Modal -->
    <div id="task-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Task Started!</div>
            <div class="modal-message">
                <p>Please complete the task in the opened window.</p>
                <div class="countdown" id="countdown">10</div>
                <p>Waiting for completion...</p>
            </div>
            <button class="modal-btn" onclick="completeTask()">Mark as Complete</button>
            <button class="modal-btn secondary" onclick="closeModal('task-modal')">Cancel</button>
        </div>
    </div>

    <!-- Withdrawal Request Modal -->
    <div id="withdrawal-modal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Withdraw Funds</div>
            <form id="withdrawal-form">
                <div class="form-group">
                    <label for="withdraw-currency">Currency</label>
                    <select id="withdraw-currency" required>
                        <option value="">Select Currency</option>
                        <option value="ton">TON</option>
                        <option value="usdt">USDT</option>
                        <option value="gold">Gold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="withdraw-amount">Amount</label>
                    <input type="number" id="withdraw-amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="withdraw-wallet">Wallet Address</label>
                    <input type="text" id="withdraw-wallet" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="submit-btn">Request Withdrawal</button>
                    <button type="button" class="cancel-btn" onclick="closeModal('withdrawal-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Generic Notification/Alert Modal -->
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <span class="material-icons" id="notification-icon" style="font-size: 48px; color: #4ecdc4;">info</span>
            <div class="modal-title" id="notification-title">Notification</div>
            <div class="modal-message" id="notification-message"></div>
            <button class="modal-btn" onclick="closeModal('notification-modal')">OK</button>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, push, onValue, update, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHpiJavjopegeZO-nAGVjWjM-zmjJk07w",
            authDomain: "monebux-my-clint.firebaseapp.com",
            databaseURL: "https://monebux-my-clint-default-rtdb.firebaseio.com",
            projectId: "monebux-my-clint",
            storageBucket: "monebux-my-clint.firebasestorage.app",
            messagingSenderId: "908326371450",
            appId: "1:908326371450:web:57ffb3de904d0400007bc3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Global variables
        let currentUser = null;
        let giveaways = {};
        let tasks = {};
        let categories = {};
        let withdrawals = {}; // For withdrawal history
        let currentTaskId = null;
        let adsWatched = 0;
        const maxAdsPerDay = 10; // Configurable
        let currentActivePage = 'giveaways'; // Track active page for nav

        // --- Telegram WebApp Initialization ---
        let tg = window.Telegram?.WebApp;
        if (tg) {
            tg.ready();
            tg.expand();
            tg.enableClosingConfirmation(); // Optional: Ask before closing
        }

        // --- Utility Functions ---
        function closeModal(modalId = 'notification-modal') {
            document.getElementById(modalId).classList.remove('active');
        }

        function showModal(modalId = 'notification-modal') {
            document.getElementById(modalId).classList.add('active');
        }

        function showNotification(message, type = 'info', title = 'Notification') {
            const modal = document.getElementById('notification-modal');
            const iconMap = {
                'success': 'check_circle',
                'error': 'error',
                'info': 'info',
                'warning': 'warning'
            };
            const colorMap = {
                'success': '#4ecdc4',
                'error': '#ef5350',
                'info': '#42a5f5',
                'warning': '#ffa726'
            };

            document.getElementById('notification-icon').textContent = iconMap[type] || 'info';
            document.getElementById('notification-icon').style.color = colorMap[type] || '#42a5f5';
            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;
            showModal('notification-modal');
        }

        // --- Balance Display and Update ---
        function updateBalanceDisplay(balance) {
            document.getElementById('ticket-balance').textContent = (balance?.ticket || 0).toFixed(2);
            document.getElementById('gold-balance').textContent = (balance?.gold || 0).toFixed(2);
            document.getElementById('ton-balance').textContent = (balance?.ton || 0).toFixed(2);
            document.getElementById('usdt-balance').textContent = (balance?.usdt || 0).toFixed(2);
        }

        // --- Firebase Initialization and User Management ---
        async function initUser() {
            let userId, username;
            
            if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id.toString();
                username = tg.initDataUnsafe.user.username || tg.initDataUnsafe.user.first_name || `User_${userId.slice(-4)}`;
            } else {
                // Fallback for testing (use unique IDs to simulate different users)
                userId = 'test_user_' + (localStorage.getItem('testUserId') || Math.floor(Math.random() * 100000));
                username = 'Demo User';
                localStorage.setItem('testUserId', userId.split('_')[2]); // Keep test ID consistent per session
            }

            currentUser = {
                id: userId,
                username: username
            };

            const userRef = ref(db, `users/${userId}`);
            const userSnapshot = await get(userRef);
            
            if (!userSnapshot.exists()) {
                // New user - check for referral
                const urlParams = new URLSearchParams(window.location.search);
                const referrerId = urlParams.get('start');
                
                const newUser = {
                    id: userId,
                    username: username,
                    balance: {
                        ticket: 0,
                        gold: 0,
                        ton: 0,
                        usdt: 0
                    },
                    createdAt: Date.now(),
                    referredBy: referrerId || null,
                    referrals: {},
                    completedTasks: {},
                    lastAdDate: null,
                    adsWatchedToday: 0,
                    claimableReferral: {
                        ticket: 0,
                        gold: 0,
                        ton: 0, // Add ton/usdt to claimable
                        usdt: 0
                    }
                };
                
                await set(userRef, newUser);
                
                // If referred, update referrer's data
                if (referrerId && referrerId !== userId) { // Prevent self-referral
                    const referrerRef = ref(db, `users/${referrerId}/referrals/${userId}`);
                    await set(referrerRef, {
                        username: username,
                        joinedAt: Date.now()
                    });
                }
            }

            // Listen for real-time updates to user data
            onValue(userRef, (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    updateBalanceDisplay(userData.balance);
                    adsWatched = userData.adsWatchedToday || 0;
                    updateAdsDisplay();
                    updateClaimableAmount(userData.claimableReferral);
                    updateFriendsCount(userData.referrals);
                    updateWithdrawalHistory(); // Load history when user data loads
                    updateMoreMenuState(userData.balance); // Enable/disable withdraw based on balance
                }
            });

            // Load static data after user is initialized
            loadData();
        }

        // --- Data Loading Functions ---
        function loadData() {
            loadGiveaways();
            loadTasks();
            loadCategories();
            loadRecentWinners();
        }

        function loadGiveaways() {
            const giveawaysRef = ref(db, 'giveaways');
            onValue(giveawaysRef, (snapshot) => {
                giveaways = snapshot.val() || {};
                renderGiveaways();
                checkGiveawayCompletion();
            });
        }

        function loadTasks() {
            const tasksRef = ref(db, 'tasks');
            onValue(tasksRef, (snapshot) => {
                tasks = snapshot.val() || {};
                renderTasks();
            });
        }

        function loadCategories() {
            const categoriesRef = ref(db, 'categories');
            onValue(categoriesRef, (snapshot) => {
                categories = snapshot.val() || {};
                renderCategoryFilter();
            });
        }

        function loadRecentWinners() {
            const winnersRef = ref(db, 'winners');
            onValue(winnersRef, (snapshot) => {
                const winners = snapshot.val() || {};
                renderRecentWinners(winners);
            });
        }

        function updateWithdrawalHistory() {
            const withdrawalsRef = ref(db, `withdrawals/${currentUser.id}`);
            onValue(withdrawalsRef, (snapshot) => {
                withdrawals = snapshot.val() || {};
                renderWithdrawalsHistory();
            });
        }

        // --- Rendering Functions ---
        function renderGiveaways() {
            const container = document.getElementById('giveaways-container');
            container.innerHTML = '';

            const activeGiveaways = Object.entries(giveaways).filter(([id, giveaway]) => !giveaway.completed);
            
            if (activeGiveaways.length === 0) {
                container.innerHTML = '<div class="card"><p>No active giveaways available.</p></div>';
                return;
            }

            activeGiveaways.forEach(([id, giveaway]) => {
                const participants = giveaway.participants || {};
                const userParticipation = participants[currentUser.id] || 0;
                const totalTicketsSold = Object.values(participants).reduce((sum, tickets) => sum + tickets, 0);
                const progress = giveaway.totalTickets > 0 ? Math.round((totalTicketsSold / giveaway.totalTickets) * 100) : 0;

                const card = document.createElement('div');
                card.className = 'card giveaway-card';
                card.innerHTML = `
                    <div class="giveaway-header">
                        <img src="${giveaway.icon || 'placeholder.png'}" alt="Icon" class="giveaway-icon">
                        <div class="giveaway-info">
                            <h3>${giveaway.title}</h3>
                            <div class="prize-info">
                                <span class="material-icons" style="font-size: 18px; vertical-align: middle;">paid</span> 
                                ${giveaway.prizeAmount} ${giveaway.prizeType.toUpperCase()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    
                    <div class="progress-text">
                        <span>${totalTicketsSold}/${giveaway.totalTickets} tickets</span>
                        <span>${progress}%</span>
                    </div>
                    
                    <button class="participate-btn" id="participate-btn-${id}" onclick="participateGiveaway('${id}')">
                        <span class="material-icons" style="font-size: 18px; vertical-align: middle;">confirmation_number</span> 
                        +1 Ticket (${giveaway.ticketPrice} tickets)
                    </button>
                    
                    <div class="my-tickets">
                        My tickets for this giveaway: ${userParticipation} / ${giveaway.ticketPrice} 🎫
                    </div>
                `;
                container.appendChild(card);

                // Disable button if not enough tickets or already maxed out for this ticket price
                const participateBtn = document.getElementById(`participate-btn-${id}`);
                const userBalance = currentUser.balance?.ticket || 0;
                if (userBalance < giveaway.ticketPrice || userParticipation >= giveaway.ticketPrice) {
                    participateBtn.disabled = true;
                    participateBtn.textContent = userBalance < giveaway.ticketPrice ? "Insufficient Tickets" : "Max Tickets";
                }
            });
        }

        function renderCategoryFilter() {
            const container = document.getElementById('category-filter');
            // Remove dynamically added buttons to re-render
            container.querySelectorAll('.dynamic-category-btn').forEach(btn => btn.remove());

            Object.entries(categories).forEach(([id, category]) => {
                const button = document.createElement('button');
                button.className = 'category-btn dynamic-category-btn';
                button.textContent = category.name;
                button.onclick = () => filterTasks(id);
                container.appendChild(button);
            });
        }

        function renderTasks(filterCategory = 'all') {
            const container = document.getElementById('tasks-container');
            container.innerHTML = '';

            const filteredTasks = Object.entries(tasks).filter(([id, task]) => filterCategory === 'all' || task.categoryId === filterCategory);
            
            if (filteredTasks.length === 0) {
                container.innerHTML = '<div class="card"><p>No tasks available for this category.</p></div>';
                return;
            }

            filteredTasks.forEach(([id, task]) => {
                const isCompleted = task.completions?.[currentUser.id];
                
                const card = document.createElement('div');
                card.className = 'card task-card';
                card.innerHTML = `
                    <img src="${task.icon || 'placeholder.png'}" alt="Icon" class="task-icon">
                    <div class="task-info">
                        <div class="task-title">${task.title}</div>
                        <div class="task-description">${task.description}</div>
                        <div class="task-reward">
                            <span class="material-icons" style="font-size: 16px; vertical-align: middle;">paid</span>
                            +${task.rewardAmount} ${task.rewardType.toUpperCase()}
                        </div>
                    </div>
                    <button class="task-btn" ${isCompleted ? 'disabled' : ''} onclick="startTask('${id}', '${task.link}')">
                        ${isCompleted ? 'Completed' : 'Start'}
                    </button>
                `;
                container.appendChild(card);
            });
        }

        function renderRecentWinners(winners) {
            const container = document.getElementById('recent-winners');
            container.innerHTML = '';
            
            const sortedWinners = Object.values(winners)
                .sort((a, b) => b.wonAt - a.wonAt)
                .slice(0, 5); // Show latest 5 winners
            
            if (sortedWinners.length === 0) {
                container.innerHTML = '<p>🐻 No winners yet</p>';
                return;
            }
            
            sortedWinners.forEach(winner => {
                const item = document.createElement('div');
                item.className = 'history-item';
                // Display a portion of the user ID and their username if available
                const winnerIdentifier = winner.username ? `@${winner.username}` : `User #${winner.userId.slice(-4)}`;
                item.innerHTML = `
                    <div class="history-user">
                        <span class="material-icons" style="font-size: 18px; color: #4ecdc4;">emoji_events</span> 
                        ${winnerIdentifier}
                    </div>
                    <div class="history-prize">
                        <span class="material-icons" style="font-size: 16px; vertical-align: middle;">paid</span> 
                        ${winner.prizeAmount} ${winner.prizeType.toUpperCase()}
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function renderWithdrawalsHistory() {
            const container = document.getElementById('withdrawals-history-container');
            container.innerHTML = '';
            
            if (!withdrawals || Object.keys(withdrawals).length === 0) {
                container.innerHTML = '<p>No withdrawal history yet.</p>';
                return;
            }

            // Sort by date, newest first
            const sortedWithdrawals = Object.entries(withdrawals)
                .sort(([idA, withdrawalA], [idB, withdrawalB]) => withdrawalB.requestedAt - withdrawalA.requestedAt);

            sortedWithdrawals.forEach(([id, withdrawal]) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                const statusClass = withdrawal.status || 'pending';
                const date = new Date(withdrawal.requestedAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                item.innerHTML = `
                    <div>
                        <div class="history-user">
                            <span class="material-icons" style="font-size: 18px; color: #888;">paid</span> 
                            ${withdrawal.amount} ${withdrawal.type.toUpperCase()}
                        </div>
                        <div style="font-size: 0.8rem; color: #aaa;">${date}</div>
                    </div>
                    <div class="history-status ${statusClass}">${statusClass}</div>
                `;
                container.appendChild(item);
            });
        }

        // --- Page Navigation ---
        window.showPage = function(pageName) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(`${pageName}-page`).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            currentActivePage = pageName; // Update current page tracker
        }

        // --- Giveaway Logic ---
        window.participateGiveaway = async function(giveawayId) {
            const giveaway = giveaways[giveawayId];
            if (!giveaway || giveaway.completed) return showNotification('Giveaway is no longer active.', 'error');

            const userBalance = currentUser.balance?.ticket || 0;
            const userParticipation = (giveaway.participants?.[currentUser.id] || 0);

            if (userBalance < giveaway.ticketPrice) {
                return showNotification('Insufficient tickets!', 'error');
            }
            if (userParticipation >= giveaway.ticketPrice) {
                return showNotification('You have already purchased the maximum tickets for this giveaway.', 'warning');
            }

            try {
                showNotification('Participating in giveaway...', 'info', 'Processing');
                
                // Deduct tickets from user balance
                await update(ref(db, `users/${currentUser.id}/balance`), { ticket: userBalance - giveaway.ticketPrice });

                // Add/update user participation for this giveaway
                const newParticipation = userParticipation + giveaway.ticketPrice;
                await update(ref(db, `giveaways/${giveawayId}/participants`), {
                    [currentUser.id]: newParticipation
                });

                closeModal('notification-modal'); // Close loading notification
                showNotification('Successfully participated! Your ticket has been added.', 'success');
                
                // Re-render immediately to update UI
                renderGiveaways(); 

            } catch (error) {
                console.error("Participation Error:", error);
                showNotification('Failed to participate. Please try again.', 'error');
            }
        }

        async function checkGiveawayCompletion() {
            for (const [id, giveaway] of Object.entries(giveaways)) {
                if (!giveaway.completed) {
                    const participants = giveaway.participants || {};
                    const totalTicketsSold = Object.values(participants).reduce((sum, tickets) => sum + tickets, 0);
                    
                    if (totalTicketsSold >= giveaway.totalTickets) {
                        await processGiveawayCompletion(id, giveaway, participants, totalTicketsSold);
                    }
                }
            }
        }

        async function processGiveawayCompletion(giveawayId, giveaway, participants, totalTicketsSold) {
            const participantIds = Object.keys(participants);
            if (participantIds.length === 0) return;

            // Select a single random winner from the participants list
            const winnerId = participantIds[Math.floor(Math.random() * participantIds.length)];
            const winnerInfo = await getUserInfo(winnerId); // Fetch winner's username
            const winnerUsername = winnerInfo ? winnerInfo.username : `User #${winnerId.slice(-4)}`;
            const prizeAmount = giveaway.prizeAmount;
            const prizeType = giveaway.prizeType;

            try {
                // Update giveaway as completed
                await update(ref(db, `giveaways/${giveawayId}`), {
                    completed: true,
                    winnerId: winnerId,
                    winnerUsername: winnerUsername,
                    completedAt: Date.now()
                });

                // Award prize to winner if they exist in our user database
                if (winnerInfo) {
                    const winnerBalanceRef = ref(db, `users/${winnerId}/balance/${prizeType}`);
                    const winnerSnapshot = await get(winnerRef);
                    const currentBalance = winnerSnapshot.val() || 0;
                    await set(winnerBalanceRef, currentBalance + prizeAmount);
                } else {
                    console.warn(`Winner ${winnerId} not found in user database. Prize not awarded directly.`);
                    // Optionally, you could store this prize to be awarded later if the user logs in.
                }

                // Add to global winners history
                const winnersRef = ref(db, 'winners');
                const newWinnerRef = push(winnersRef);
                await set(newWinnerRef, {
                    userId: winnerId,
                    username: winnerUsername,
                    giveawayId: giveawayId,
                    giveawayTitle: giveaway.title,
                    prizeAmount: prizeAmount,
                    prizeType: prizeType,
                    wonAt: Date.now()
                });

                showNotification(`🎉 Giveaway "${giveaway.title}" completed! ${winnerUsername} won ${prizeAmount} ${prizeType.toUpperCase()}!`, 'success', 'Giveaway Ended');

            } catch (error) {
                console.error("Error completing giveaway:", error);
                showNotification('Failed to process giveaway completion.', 'error');
            }
        }

        async function getUserInfo(userId) {
            try {
                const userRef = ref(db, `users/${userId}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    return snapshot.val();
                }
                return null;
            } catch (error) {
                console.error("Error fetching user info:", error);
                return null;
            }
        }

        // --- Task Logic ---
        window.filterTasks = function(categoryId) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active'));
            // Use event.target.closest if event is triggered by nested element
            const clickedBtn = event.target.closest('.category-btn');
            if (clickedBtn) clickedBtn.classList.add('active');
            renderTasks(categoryId);
        }

        window.startTask = function(taskId, taskLink) {
            currentTaskId = taskId;
            
            // Store current task details if needed by completion logic
            const task = tasks[taskId];
            if (task) {
                sessionStorage.setItem('currentTask', JSON.stringify({ id: taskId, ...task }));
            }

            window.open(taskLink, '_blank');
            
            showModal('task-modal');
            startCountdown();
        }

        function startCountdown() {
            let count = 10;
            const countdownEl = document.getElementById('countdown');
            countdownEl.textContent = count;
            
            const timer = setInterval(() => {
                count--;
                countdownEl.textContent = count < 0 ? 'Ready!' : count;
                
                if (count < 0) {
                    clearInterval(timer);
                }
            }, 1000);
        }

        window.completeTask = async function() {
            const currentTaskString = sessionStorage.getItem('currentTask');
            if (!currentTaskString) {
                closeModal('task-modal');
                return showNotification('Task details not found. Please try starting the task again.', 'error');
            }
            
            const task = JSON.parse(currentTaskString);
            sessionStorage.removeItem('currentTask');

            if (!task || !task.id) {
                closeModal('task-modal');
                return showNotification('Invalid task data.', 'error');
            }
            
            const taskRef = ref(db, `tasks/${task.id}/completions`);
            const userCompletionRef = ref(db, `users/${currentUser.id}/completedTasks/${task.id}`);
            const userBalanceRef = ref(db, `users/${currentUser.id}/balance/${task.rewardType}`);
            const userReferralClaimRef = ref(db, `users/${currentUser.id}/claimableReferral/${task.rewardType}`);

            try {
                // Mark task as completed for the user
                await set(userCompletionRef, Date.now());
                await update(taskRef, { [currentUser.id]: Date.now() }); // Also update in tasks node

                // Award user
                const balanceSnapshot = await get(userBalanceRef);
                const currentBalance = balanceSnapshot.val() || 0;
                await set(userBalanceRef, currentBalance + task.rewardAmount);

                // Award referrer commission
                const userDoc = await get(ref(db, `users/${currentUser.id}`));
                const userData = userDoc.val();
                
                if (userData && userData.referredBy) {
                    const referrerBalanceSnapshot = await get(userReferralClaimRef);
                    const referrerBalance = referrerBalanceSnapshot.val() || 0;
                    const commission = task.rewardAmount * 0.1; // 10% commission
                    await set(userReferralClaimRef, referrerBalance + commission);
                }

                closeModal('task-modal');
                showNotification(`Task completed! +${task.rewardAmount} ${task.rewardType.toUpperCase()}`, 'success');
                
                // Re-render tasks to update button state
                renderTasks(document.querySelector('.category-btn.active').dataset.categoryId || 'all'); 

            } catch (error) {
                console.error("Task completion error:", error);
                closeModal('task-modal');
                showNotification('Failed to complete task. Please try again later.', 'error');
            }
        }

        // --- Ad Logic ---
        window.watchAd = function() {
            if (adsWatched >= maxAdsPerDay) {
                return showNotification('Maximum ads watched for today!', 'warning');
            }

            const today = new Date().toDateString();
            const lastAdDate = localStorage.getItem('lastAdDate');
            
            // Reset watched count if it's a new day
            if (lastAdDate !== today) {
                adsWatched = 0;
                localStorage.setItem('lastAdDate', today);
                // Update Firebase with the reset date and count
                update(ref(db, `users/${currentUser.id}`), {
                    lastAdDate: today,
                    adsWatchedToday: 0
                });
            }

            // Trigger ad SDK (assuming show_9900905 is globally available from the script)
            if (typeof show_9900905 === 'function') {
                show_9900905();
                showNotification('Ad is loading...', 'info');
                
                // Simulate ad completion after a delay
                setTimeout(async () => {
                    const adRewardAmount = 0.1; // Tickets
                    const adRewardType = 'ticket';
                    const referralCommissionRate = 0.1; // 10%

                    try {
                        // Update user's balance
                        const userBalanceRef = ref(db, `users/${currentUser.id}/balance/${adRewardType}`);
                        const balanceSnapshot = await get(userBalanceRef);
                        const currentBalance = balanceSnapshot.val() || 0;
                        await set(userBalanceRef, currentBalance + adRewardAmount);

                        // Update ads watched count and date in Firebase
                        adsWatched++;
                        await update(ref(db, `users/${currentUser.id}`), {
                            adsWatchedToday: adsWatched,
                            lastAdDate: today // Ensure date is also updated if it was a new day
                        });
                        updateAdsDisplay(); // Update local display

                        // Award referrer
                        const userDoc = await get(ref(db, `users/${currentUser.id}`));
                        const userData = userDoc.val();
                        
                        if (userData && userData.referredBy) {
                            const referrerClaimRef = ref(db, `users/${userData.referredBy}/claimableReferral/${adRewardType}`);
                            const referrerClaimSnapshot = await get(referrerClaimRef);
                            const referrerClaim = referrerClaimSnapshot.val() || 0;
                            const commission = adRewardAmount * referralCommissionRate;
                            await set(referrerClaimRef, referrerClaim + commission);
                        }

                        showNotification(`Ad completed! +${adRewardAmount} ${adRewardType.toUpperCase()}`, 'success');

                    } catch (error) {
                        console.error("Ad completion error:", error);
                        showNotification('Failed to process ad reward. Please try again.', 'error');
                    }
                }, 15000); // Simulate ad duration (e.g., 15 seconds) - ADJUST AS NEEDED
            } else {
                showNotification('Ad service not available. Please try again later.', 'error');
            }
        }

        function updateAdsDisplay() {
            document.getElementById('ads-watched').textContent = `Today: ${adsWatched}/${maxAdsPerDay} ads watched`;
        }

        // --- Referral Logic ---
        window.inviteFriend = function() {
            if (!currentUser) return showNotification('User not initialized yet.', 'error');

            const botUsername = 'YourTelegramBotUsername'; // <-- IMPORTANT: Replace with your bot's username
            const referLink = `https://t.me/${botUsername}/app?start=${currentUser.id}`;
            const shareText = `🎁 Join MoneBux and start earning tickets and rewards! Use my referral link to get a bonus and earn from my activity!`;
            
            if (tg) {
                // Use Telegram's share functionality for best integration
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(referLink)}&text=${encodeURIComponent(shareText)}`);
            } else {
                // Fallback for desktop or web where tg.openTelegramLink might not work as expected
                navigator.clipboard.writeText(referLink).then(() => {
                    showNotification('Referral link copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy referral link: ', err);
                    showNotification('Could not copy referral link. Please copy it manually: ' + referLink, 'warning');
                });
            }
        }

        function updateFriendsCount(referrals) {
            const count = Object.keys(referrals || {}).length;
            document.getElementById('friends-count').textContent = count;
        }

        function updateClaimableAmount(claimable) {
            const ticket = claimable?.ticket || 0;
            const gold = claimable?.gold || 0;
            const ton = claimable?.ton || 0;
            const usdt = claimable?.usdt || 0;
            document.getElementById('claimable-amount').textContent = `${ticket.toFixed(2)} 🎫 ${gold.toFixed(2)} 🌟 ${ton.toFixed(2)} 💎 ${usdt.toFixed(2)} 💲`;
            
            // Enable claim button only if there's something to claim
            const claimBtn = document.getElementById('claim-referral-btn');
            if (ticket > 0 || gold > 0 || ton > 0 || usdt > 0) {
                claimBtn.disabled = false;
            } else {
                claimBtn.disabled = true;
            }
        }

        window.claimReferral = async function() {
            const userSnapshot = await get(ref(db, `users/${currentUser.id}`));
            const userData = userSnapshot.val();
            const claimable = userData.claimableReferral || {};
            
            if ((claimable.ticket || 0) <= 0 && (claimable.gold || 0) <= 0 && (claimable.ton || 0) <= 0 && (claimable.usdt || 0) <= 0) {
                return showNotification('No rewards to claim!', 'warning');
            }

            try {
                const currentBalance = userData.balance || {};
                const newBalance = {
                    ticket: (currentBalance.ticket || 0) + (claimable.ticket || 0),
                    gold: (currentBalance.gold || 0) + (claimable.gold || 0),
                    ton: (currentBalance.ton || 0) + (claimable.ton || 0),
                    usdt: (currentBalance.usdt || 0) + (claimable.usdt || 0)
                };
                
                await update(ref(db, `users/${currentUser.id}`), {
                    balance: newBalance,
                    claimableReferral: { ticket: 0, gold: 0, ton: 0, usdt: 0 } // Reset claimable amounts
                });
                
                showNotification('Referral rewards claimed successfully!', 'success');
            } catch (error) {
                console.error("Claim referral error:", error);
                showNotification('Failed to claim referral rewards. Please try again.', 'error');
            }
        }

        // --- Withdrawal Logic ---
        function toggleMoreMenu() {
            showModal('more-menu-modal');
        }

        window.openWithdrawalModal = function() {
            closeModal('more-menu-modal');
            // Populate withdrawal modal based on current balances
            const balance = currentUser.balance || {};
            const tonBalance = balance.ton || 0;
            const usdtBalance = balance.usdt || 0;
            const goldBalance = balance.gold || 0;

            const currencySelect = document.getElementById('withdraw-currency');
            currencySelect.innerHTML = '<option value="">Select Currency</option>'; // Reset options
            
            if (tonBalance > 0) currencySelect.innerHTML += `<option value="ton">TON (${tonBalance.toFixed(2)})</option>`;
            if (usdtBalance > 0) currencySelect.innerHTML += `<option value="usdt">USDT (${usdtBalance.toFixed(2)})</option>`;
            if (goldBalance > 0) currencySelect.innerHTML += `<option value="gold">Gold (${goldBalance.toFixed(2)})</option>`;
            
            if (currencySelect.children.length === 1) { // Only the default option
                showNotification('You have no funds to withdraw.', 'warning');
                return;
            }

            showModal('withdrawal-modal');
        }

        document.getElementById('withdrawal-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const currency = document.getElementById('withdraw-currency').value;
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const wallet = document.getElementById('withdraw-wallet').value.trim();
            const userBalance = currentUser.balance?.[currency] || 0;

            if (!currency || isNaN(amount) || amount <= 0 || !wallet) {
                return showNotification('Please fill in all fields correctly.', 'warning');
            }
            if (amount > userBalance) {
                return showNotification(`Insufficient ${currency.toUpperCase()} balance.`, 'warning');
            }

            // Basic wallet address validation (can be more sophisticated)
            if (currency === 'ton' && !wallet.startsWith('UQ')) { // Basic TON address format
                 //return showNotification('Invalid TON wallet address format.', 'warning');
            }
            if (currency === 'usdt' && wallet.length < 26) { // Basic USDT address format (often similar to ETH)
                 //return showNotification('Invalid USDT wallet address format.', 'warning');
            }

            const withdrawalData = {
                userId: currentUser.id,
                username: currentUser.username,
                amount: amount,
                type: currency,
                wallet: wallet,
                status: 'pending',
                requestedAt: Date.now(),
                processedAt: null
            };

            try {
                // Deduct amount from user balance immediately
                const newBalance = { ...currentUser.balance };
                newBalance[currency] = (newBalance[currency] || 0) - amount;
                await update(ref(db, `users/${currentUser.id}/balance`), newBalance);
                
                // Save withdrawal request to Firebase
                const withdrawalRef = ref(db, `withdrawals/${currentUser.id}/${Date.now()}`); // Use timestamp as unique ID
                await set(withdrawalRef, withdrawalData);

                closeModal('withdrawal-modal');
                showNotification('Withdrawal request submitted successfully! It will be processed shortly.', 'success');
                
            } catch (error) {
                console.error("Withdrawal request error:", error);
                // If error occurs after balance deduction, you might need a rollback mechanism
                showNotification('Failed to submit withdrawal request. Please try again.', 'error');
            }
        });

        function updateMoreMenuState(balance) {
            const withdrawBtn = document.querySelector('#more-menu-modal .modal-btn');
            let hasFundsToWithdraw = false;
            if (balance) {
                if ((balance.ton || 0) > 0) hasFundsToWithdraw = true;
                if ((balance.usdt || 0) > 0) hasFundsToWithdraw = true;
                if ((balance.gold || 0) > 0) hasFundsToWithdraw = true;
            }

            if (withdrawBtn) {
                withdrawBtn.disabled = !hasFundsToWithdraw;
                if (!hasFundsToWithdraw) {
                    withdrawBtn.style.opacity = '0.5';
                    withdrawBtn.style.cursor = 'not-allowed';
                } else {
                    withdrawBtn.style.opacity = '1';
                    withdrawBtn.style.cursor = 'pointer';
                }
            }
        }

        // --- Initialization ---
        initUser(); // Start user initialization which then calls loadData()
    </script>
</body>
</html>
